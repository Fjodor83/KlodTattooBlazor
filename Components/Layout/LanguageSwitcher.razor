@using KlodTattooBlazor.Services
@inject LocalizationService Localization
@implements IDisposable

<div class="dropdown d-inline-block position-relative">
    <button class="btn btn-link text-white dropdown-toggle text-decoration-none d-flex align-items-center"
            type="button"
            @onclick="ToggleDropdown"
            style="padding: 0.5rem 1rem; line-height: 1;">
        <img src="@CurrentLanguageFlag" alt="Flag" class="flag-icon me-2" style="width: 20px !important; height: 15px !important; object-fit: cover;" />
        <span class="d-none d-md-inline">@CurrentLanguageName</span>
        <span class="d-inline d-md-none">@CurrentLanguageCode</span>
    </button>

    @if (IsDropdownOpen)
    {
        <div class="dropdown-backdrop" @onclick="CloseDropdown"></div>
    }

    <ul class="dropdown-menu dropdown-menu-end dropdown-menu-dark shadow @(IsDropdownOpen ? "show" : "")"
        style="border: 1px solid rgba(212, 175, 55, 0.2);">
        <li>
            <button class="dropdown-item d-flex align-items-center justify-content-between @(CurrentLanguage == "de-DE" ? "active" : "")"
                    type="button"
                    @onclick="@(() => ChangeLanguage("de-DE"))"
                    style="line-height: 1.5;">
                <span class="d-flex align-items-center">
                    <img src="/images/flags/de.svg" class="flag-icon me-2" style="width: 20px !important; height: 15px !important; object-fit: cover;" alt="DE" />
                    Deutsch
                </span>
                @if (CurrentLanguage == "de-DE")
                {
                    <i class="fas fa-check text-gold small"></i>
                }
            </button>
        </li>
        <li>
            <button class="dropdown-item d-flex align-items-center justify-content-between @(CurrentLanguage == "en" ? "active" : "")"
                    type="button"
                    @onclick="@(() => ChangeLanguage("en"))"
                    style="line-height: 1.5;">
                <span class="d-flex align-items-center">
                    <img src="/images/flags/en.svg" class="flag-icon me-2" style="width: 20px !important; height: 15px !important; object-fit: cover;" alt="EN" />
                    English
                </span>
                @if (CurrentLanguage == "en")
                {
                    <i class="fas fa-check text-gold small"></i>
                }
            </button>
        </li>
        <li>
            <button class="dropdown-item d-flex align-items-center justify-content-between @(CurrentLanguage == "it-IT" ? "active" : "")"
                    type="button"
                    @onclick="@(() => ChangeLanguage("it-IT"))"
                    style="line-height: 1.5;">
                <span class="d-flex align-items-center">
                    <img src="/images/flags/it.svg" class="flag-icon me-2" style="width: 20px !important; height: 15px !important; object-fit: cover;" alt="IT" />
                    Italiano
                </span>
                @if (CurrentLanguage == "it-IT")
                {
                    <i class="fas fa-check text-gold small"></i>
                }
            </button>
        </li>
    </ul>
</div>

@code {
    private bool IsDropdownOpen = false;

    private string CurrentLanguage => Localization.CurrentCulture;

    private string CurrentLanguageName => CurrentLanguage switch
    {
        "de-DE" => "Deutsch",
        "it-IT" => "Italiano",
        _ => "English"
    };

    private string CurrentLanguageCode => CurrentLanguage switch
    {
        "de-DE" => "DE",
        "it-IT" => "IT",
        _ => "EN"
    };

    private string CurrentLanguageFlag => CurrentLanguage switch
    {
        "de-DE" => "/images/flags/de.svg",
        "it-IT" => "/images/flags/it.svg",
        _ => "/images/flags/en.svg"
    };

    protected override void OnInitialized()
    {
        Localization.OnCultureChanged += StateHasChanged;
    }

    public void Dispose()
    {
        Localization.OnCultureChanged -= StateHasChanged;
    }

    private void ToggleDropdown()
    {
        IsDropdownOpen = !IsDropdownOpen;
    }

    private void CloseDropdown()
    {
        IsDropdownOpen = false;
    }

    private async Task ChangeLanguage(string culture)
    {
        await Localization.SetCultureAsync(culture);
        IsDropdownOpen = false;
    }
}