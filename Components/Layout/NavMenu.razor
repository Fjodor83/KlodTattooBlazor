@inject NavigationManager NavigationManager
@inject IJSRuntime JS
@inject KlodTattooBlazor.Services.LocalizationService Localization
@implements IDisposable

<nav class="navbar navbar-expand-lg navbar-dark @NavbarClass" data-dynamic-navbar="@IsHomePage.ToString().ToLower()">
    <div class="container-fluid px-3 px-lg-4">
        <!-- Logo/Brand -->
        <a class="navbar-brand d-flex align-items-center" href="/" @onclick="CloseNavMenu">
            <img src="/images/klod_logo.png" alt="Klod Tattoo Logo" class="navbar-logo-custom" />
        </a>

        <!-- Backdrop for click-outside closing -->
        @if (!collapseNavMenu)
        {
            <div class="nav-backdrop" @onclick="CloseNavMenu"></div>
        }

        <!-- Mobile Toggle -->
        <button class="navbar-toggler border-0" type="button" @onclick="ToggleNavMenu">
            <span class="navbar-toggler-icon"></span>
        </button>

        <!-- Nav Items -->
        <div class="@NavMenuCssClass navbar-collapse align-items-center" id="navbarNav">
            <!-- Main Navigation -->
            <ul class="navbar-nav ms-auto align-items-center gap-2 mb-3 mb-lg-0">
                <li class="nav-item">
                    <NavLink class="nav-link px-2 position-relative nav-link-custom d-flex align-items-center" href="" Match="NavLinkMatch.All" @onclick="CloseNavMenu">
                        <i class="fas fa-home me-1"></i>@Localization["Nav_Home"]
                    </NavLink>
                </li>
                <li class="nav-item">
                    <NavLink class="nav-link px-2 position-relative nav-link-custom d-flex align-items-center" href="portfolio" @onclick="CloseNavMenu">
                        <i class="fas fa-images me-1"></i>@Localization["Nav_Portfolio"]
                    </NavLink>
                </li>
                <li class="nav-item">
                    <NavLink class="nav-link px-2 position-relative nav-link-custom d-flex align-items-center" href="services" @onclick="CloseNavMenu">
                        <i class="fas fa-palette me-1"></i>@Localization["Nav_Services"]
                    </NavLink>
                </li>
                <li class="nav-item">
                    <NavLink class="nav-link px-2 position-relative nav-link-custom d-flex align-items-center" href="info" @onclick="CloseNavMenu">
                        <i class="fas fa-info-circle me-1"></i>@Localization["Nav_Info"]
                    </NavLink>
                </li>
                <li class="nav-item">
                    <NavLink class="nav-link px-2 position-relative nav-link-custom d-flex align-items-center" href="contacts" @onclick="CloseNavMenu">
                        <i class="fas fa-envelope me-1"></i>@Localization["Nav_Contacts"]
                    </NavLink>
                </li>
            </ul>

            <!-- Desktop Divider -->
            <div class="d-none d-lg-block mx-3" style="border-right: 1px solid rgba(255,255,255,0.2); height: 24px;"></div>

            <!-- Functional Group (Language + Booking) -->
            <div class="d-flex align-items-center gap-3 flex-column flex-lg-row">
                <!-- Language Switcher -->
                <LanguageSwitcher />

                <!-- Booking Button -->
                <a class="btn btn-gold px-4 py-2 rounded-pill shadow-sm" href="booking" @onclick="CloseNavMenu">
                    <i class="fas fa-calendar-check me-2"></i>@Localization["Nav_BookNow"]
                </a>
            </div>
        </div>
    </div>
</nav>

@code {
    [Parameter]
    public bool IsHomePage { get; set; }

    private bool collapseNavMenu = true;
    private string? NavMenuCssClass => collapseNavMenu ? "collapse" : null;
    // Initial state only - JavaScript will handle transparent/glass switching
    private string NavbarClass => IsHomePage ? "navbar-transparent" : "navbar-glass";


    protected override void OnInitialized()
    {
        Localization.OnCultureChanged += StateHasChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && IsHomePage)
        {
            // Initialize dynamic navbar effect after component is rendered
            await JS.InvokeVoidAsync("eval", @"
                if (typeof initDynamicNavbar === 'function') {
                    initDynamicNavbar();
                } else {
                    // Fallback: initialize directly if function is in IIFE scope
                    const navbar = document.querySelector('.navbar[data-dynamic-navbar=""true""]');
                    if (navbar) {
                        window._navbarScrollHandler = () => {
                            if (window.scrollY > 50) {
                                navbar.classList.remove('navbar-transparent');
                                navbar.classList.add('navbar-glass');
                            } else {
                                navbar.classList.add('navbar-transparent');
                                navbar.classList.remove('navbar-glass');
                            }
                        };
                        window.addEventListener('scroll', window._navbarScrollHandler, { passive: true });
                        window._navbarScrollHandler();
                    }
                }
            ");
        }
    }

    public void Dispose()
    {
        Localization.OnCultureChanged -= StateHasChanged;
    }

    private void ToggleNavMenu()
    {
        collapseNavMenu = !collapseNavMenu;
    }

    private void CloseNavMenu()
    {
        collapseNavMenu = true;
    }
}